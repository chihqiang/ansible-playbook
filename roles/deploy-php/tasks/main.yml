# 1. 拉取最新代码到应用目录（核心步骤：从 Git 仓库获取项目源代码）
- name: 拉取最新代码到应用目录
  git:  # Ansible 内置模块，用于 Git 版本控制相关操作（拉取、切换分支等）
    repo: "{{ app_repo }}"                          # Git 仓库地址（通过变量传入，支持 HTTP/SSH 协议，如 https://github.com/xxx/xxx.git）
    dest: "{{ wwwroot }}/{{ domain }}"              # 代码拉取后的目标目录（拼接网站根路径 + 域名，如 /var/www/example.com）
    version: "{{ app_version }}"                    # 要拉取的代码版本（支持分支名、标签名、commit ID，如 main、v1.0.0）
    force: yes                                      # 强制拉取：若目标目录已存在代码，覆盖本地修改（避免因本地文件冲突导致拉取失败）
    accept_hostkey: yes                             # 自动接受 Git 仓库的主机密钥（首次拉取 SSH 协议仓库时，避免手动确认密钥的交互阻塞）

# 2. 使用 composer 安装依赖（项目运行必需：安装 PHP 第三方依赖包，如框架、工具类）
- name: 安装 Composer 依赖
  shell: |
    cd {{ wwwroot }}/{{ domain }}  # 进入项目根目录（Composer 需在项目根目录执行，读取 composer.json 文件）
    /usr/local/bin/composer{{ php_version }} install  # 执行 Composer 安装命令（指定绝对路径，避免环境变量问题）
    # 注：composer install 会根据项目根目录的 composer.lock 文件安装固定版本的依赖，确保环境一致性

# 3. 设置代码目录权限（安全与运行必需：确保 Web 服务用户能读写项目文件）
- name: 设置项目文件权限
  file:  # Ansible 内置模块，用于文件/目录的权限、所有者/组管理
    path: "{{ wwwroot }}/{{ domain }}"  # 目标目录：项目根目录
    recurse: yes                       # 递归应用权限：目录下所有文件和子目录都生效
    owner: "{{ app_user }}"            # 目录所有者：Web 服务运行用户（如 www-data、nginx，通过变量传入）
    group: "{{ app_group }}"           # 目录所属组：Web 服务运行组（与所有者一致，确保权限统一）

# 4. 创建 runtime 目录（项目运行必需：存储日志、缓存、临时文件等动态生成的内容）
- name: 创建 runtime 目录
  file:
    path: "{{ wwwroot }}/{{ domain }}/runtime"  # 目标路径：项目内的 runtime 目录
    state: directory                             # 状态：确保目录存在（不存在则创建，已存在则不操作）
    owner: "{{ app_user }}"                      # 所有者：Web 服务用户（需写入权限，用于生成日志/缓存）
    group: "{{ app_group }}"                     # 所属组：Web 服务组
    mode: '0775'                                 # 目录权限：0775（所有者/组可读可写可执行，其他用户只读）
    # 0775 权限说明：Web 用户可读写（生成文件），同组用户可协作，其他用户无写入权限（安全）

# 5. 检查 Nginx 配置文件是否已存在（前置判断：避免重复创建配置文件）
- name: 检查 Nginx 配置文件是否存在
  stat:  # Ansible 内置模块，用于获取文件/目录的状态信息（是否存在、权限、修改时间等）
    path: "/etc/nginx/conf.d/{{ domain }}.conf"  # 要检查的文件路径：Nginx 站点配置文件（以域名为文件名，便于识别）
  register: nginx_conf_stat  # 注册检查结果到变量 nginx_conf_stat，后续通过该变量判断文件是否存在

# 6. 初始化 Nginx 配置（仅首次部署时执行：生成站点专属 Nginx 配置）
- name: 初始化 Nginx 配置
  template:  # Ansible 内置模块，通过 Jinja2 模板生成目标文件（支持变量替换，动态适配项目）
    src: nginx-php.conf.j2  # 模板文件路径（.j2 后缀为 Jinja2 模板，内部可嵌入变量，如项目路径、域名、PHP-FPM 端口等）
    dest: "/etc/nginx/conf.d/{{ domain }}.conf"  # 目标配置文件路径（Nginx 会自动加载 conf.d 目录下的 .conf 文件）
    owner: root  # 配置文件所有者：root（系统管理员，确保配置安全，避免普通用户篡改）
    group: root  # 配置文件所属组：root
    mode: '0644' # 配置文件权限：0644（所有者可读可写，其他用户只读，符合系统配置文件权限规范）
  when: not nginx_conf_stat.stat.exists  # 条件判断：仅当 Nginx 配置文件不存在时才执行（避免覆盖已修改的配置）
  notify: reload nginx  # 触发处理器：配置文件创建后，重载 Nginx 服务（使新配置生效，且不中断现有连接）